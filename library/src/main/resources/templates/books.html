<!DOCTYPE html>
<html lang="pt-br" >
<head>
  <meta charset="UTF-8">
  <title>Google Books Application</title>
  <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha.6/css/bootstrap.min.css'>
  <link rel="stylesheet" href="books.css">
</head>
<body>

<!-- partial:index.partial.html -->
<div class="main">
  <div class="container">
    <div class="row">
      <div class="col-sm-8">
        <label>Busca por: </label>
        <input id="nameSearch" style="height: 100%; width: 650px;">
      </div>
      <div class="col-sm-4" style=" text-align: left;">
        <input id="btn-search" type="submit" value="buscar" style="height: 50px;">
      </div>
      <div class="col-sm-12">
        <label>Total de resultados: </label>
        <label></label>
      </div>
    </div>
    <div class="page-content">
      <div class="col-md-12" id="page-content">
        <!-- Dinamic Content Here -->
      </div>
    </div>
  </div>
</div>

<!-- pages -->
<div class="main">
  <ul id="pagination-demo" class="pagination-sm"></ul>
</div>

<!-- partial -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js'></script>
<script src="https://npmcdn.com/tether@1.2.4/dist/js/tether.min.js"></script>
<script src="https://npmcdn.com/bootstrap@4.0.0-alpha.5/dist/js/bootstrap.min.js"></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/twbs-pagination/1.4.1/jquery.twbsPagination.min.js'></script>
<script th:inline="javascript">
/*<![CDATA[*/
  $('#pagination-demo').twbsPagination({
    totalPages: 6,
    visiblePages: 6,
    next: 'Próximo',
    prev: 'Anterior',
    first: 'Primeiro',
    last: 'Último',
    onPageClick: function (event, page) {
        //fetch content and render here
        let indexSearch = getIdxSearchByPage(page);
        getBooksObjs(indexSearch);
    }
  });

  function getBooksObjs(indexSearch) {
      getOtherBooks(indexSearch);
  }

//TODO - refactor
  function getOtherBooks(indexSearch) {
    let name = $('#nameSearch').val();
    getBooksByNameAndIndex(indexSearch, name);
  }

  function getBooksByNameAndIndex(indexSearch, name) {
    let host =  /*[[${serverAddress}]]*/ '';
    let fullUrl = `http://${host}/books-by-index?name=${name}&index=${indexSearch}`;
    $.get(fullUrl, function(data) {
      let htmlContent = getHtmlByBooks(data);
      $('#page-content').html(htmlContent);
    });
  }

  function getHtmlByBooks(books) {
    let html =
     `<div class="container">
          <div class="row">`;
            books.forEach(function(book) {
              html += getHtml(book);
            });
     html +=
          `</div>
     </div>`;

    return html;
  }

  function getHtml(book) {
    let description = getDescriptionHtml(book.description);

    return `
    <div class="col-4 item-gallery" style="margin-bottom: 35px;">
        <a href="#">ADD FAVORITE</a>
        <div class="thumbnail">
            <img src="${book.thumbnail}">
            <div class="caption" style="margin: 5px;">
                <h5>${book.title}</h5>
                ${description}
            </div>
        </div>
    </div>`;
  }

  function getDescriptionHtml(description) {
    description = capitalize(description);

    if (description) {
      return `<div class="col-12 text-left" style="padding:20px;">
        <h6>Descrição:</h6>
        <p>${description}</p>
      </div>`;
    }
    return '';
  }

  function capitalize(s) {
    if (typeof s !== 'string') return '';
    return s.charAt(0).toUpperCase() + s.slice(1);
  }

  $('#btn-search').click(function(item) {
    let page = $('.active a').html();
    let idxSearch = getIdxSearchByPage(page);
    let name = $('#nameSearch').val();
    getBooksByNameAndIndex(idxSearch, name);
  });

  function getIdxSearchByPage(page) {
    return (page-1) + "0";
  }


/*]]>*/
</script>

</body>
</html>
